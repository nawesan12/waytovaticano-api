// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// core
model User {
  id                 String         @id @default(cuid())
  email              String         @unique
  displayName        String?
  photoUrl           String?
  createdAt          DateTime       @default(now())
  couples            CoupleMember[]
  kudos              Kudos[]
  notes              Note[]
  messagesSent       Message[]      @relation("messages_sent")
  messagesRecv       Message[]      @relation("messages_recv")
  profile            UserProfile?   @relation(fields: [userProfileUserId], references: [userId])
  settings           UserSettings?  @relation(fields: [userSettingsUserId], references: [userId])
  userProfileUserId  String?
  userSettingsUserId String?
  Message            Message[]
}

model UserProfile {
  userId        String    @id
  birthday      DateTime?
  favorites     Json? // { foods:[], music:[], places:[], activities:[], snacks:[], drinks:[] }
  dislikes      Json? // { foods:[], ingredients:[], topics:[], triggers:[] }
  allergies     String[] // food/med allergies/intolerances
  loveLanguages String[] // ["words","quality_time","acts","gifts","touch"]
  hobbies       String[]
  noGoList      String[] // boundaries / hard noâ€™s
  aboutMe       String?
  User          User[]
}

model UserSettings {
  userId        String  @id
  timezone      String? @default("America/Argentina/Buenos_Aires")
  expoPushToken String?
  dndStart      String? // "22:00"
  dndEnd        String? // "08:00"
  reminderPrefs Json? // { birthdays:true, checkin: "20:00", quests:true }
  User          User[]
}

model FamilyMember {
  id        String    @id @default(cuid())
  userId    String // owner (whose family this is)
  name      String
  relation  String // mom, dad, sister, best_friend, etc.
  birthday  DateTime?
  notes     String?
  remind    Boolean   @default(true)
  giftIdeas String[]
  createdAt DateTime  @default(now())
}

model ImportantDate {
  id       String   @id @default(cuid())
  coupleId String
  kind     String // dating_anniv | wedding_anniv | first_kiss | custom
  date     DateTime
  notes    String?
  remind   Boolean  @default(true)
  Couple   Couple   @relation(fields: [coupleId], references: [id])
}

model Couple {
  id                  String          @id @default(cuid())
  createdAt           DateTime        @default(now())
  code                String          @unique // invite code
  members             CoupleMember[]
  stats               CoupleStats?    @relation(fields: [coupleStatsCoupleId], references: [coupleId])
  quests              Quest[]
  ledger              PointsLedger[]
  achievements        Achievement[]
  important           ImportantDate[]
  coupleStatsCoupleId String?
}

model CoupleMember {
  id       String   @id @default(cuid())
  coupleId String
  userId   String
  role     String   @default("partner") // future admin tools
  joinedAt DateTime @default(now())
  User     User     @relation(fields: [userId], references: [id])
  Couple   Couple   @relation(fields: [coupleId], references: [id])

  @@unique([coupleId, userId])
}

// gamification
model CoupleStats {
  coupleId   String   @id
  level      Int      @default(1)
  xp         Int      @default(0)
  hearts     Int      @default(0)
  dayStreak  Int      @default(0)
  weekStreak Int      @default(0)
  affinity   Int      @default(0) // 0..100
  Couple     Couple[]
}

model PointsLedger {
  id        String   @id @default(cuid())
  coupleId  String
  type      String // XP|HEART|AFFINITY
  amount    Int
  reason    String // quest:kudos:checkin:achievement
  createdBy String // userId
  createdAt DateTime @default(now())
  Couple    Couple   @relation(fields: [coupleId], references: [id])
}

model Quest {
  id              String   @id @default(cuid())
  coupleId        String
  title           String
  description     String?
  schedule        String? // cron-ish or ISO repeat rule
  assignedTo      String? // userId or "both"
  xpReward        Int      @default(10)
  heartReward     Int      @default(1)
  requiresConfirm Boolean  @default(true)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  Couple          Couple   @relation(fields: [coupleId], references: [id])
}

model QuestEntry {
  id          String    @id @default(cuid())
  questId     String
  doneBy      String // userId
  note        String?
  photoUrl    String?
  status      String    @default("pending") // pending|confirmed|rejected
  createdAt   DateTime  @default(now())
  confirmedBy String?
  confirmedAt DateTime?
}

model Kudos {
  id        String   @id @default(cuid())
  coupleId  String
  fromId    String
  toId      String
  text      String
  tags      String[]
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

model Note {
  id        String   @id @default(cuid())
  coupleId  String
  authorId  String
  text      String
  isPrivate Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

model Message {
  id        String   @id @default(cuid())
  coupleId  String
  fromId    String
  toId      String
  kind      String   @default("ping") // ping|prompt|nudge
  text      String
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?
  from      User     @relation("messages_sent", fields: [fromId], references: [id])
  to        User     @relation("messages_recv", fields: [toId], references: [id])

  @@index([coupleId, toId, createdAt])
}

model Achievement {
  id       String   @id @default(cuid())
  coupleId String
  code     String   @unique // e.g., first_7_day_streak
  title    String
  details  String?
  earnedAt DateTime @default(now())
  Couple   Couple   @relation(fields: [coupleId], references: [id])
}
